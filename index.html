<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>小菜园</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="小菜园">
<meta property="og:url" content="http://bravemind.github.io/index.html">
<meta property="og:site_name" content="小菜园">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小菜园">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/blog/favicon.png">
  
  <link rel="stylesheet" href="/blog/css/normalize.css">
  <link rel="stylesheet" href="/blog/css/grid.css">

  <link rel="stylesheet" href="/blog/css/style.css">
  <link rel="stylesheet" href="/blog/css/font-awesome.min.css">



</head>
<div class="left_header">
    <a class="header_avater" href="/blog"></a>
    <div class="tag_s" id="showTag">
        <i class="fa fa-tag" href="../blog"></i>
            <div id="tags_clod" class="pop">
                    <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JavaScript/">JavaScript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Mysql/">Mysql</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/java基础/">java基础</a><span class="tag-list-count">35</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/linux/">linux</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/技术求索/">技术求索</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/设计模式/">设计模式</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/译文/">译文</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/读书笔记/">读书笔记</a><span class="tag-list-count">1</span></li></ul>
            </div>
    </div>
    <a href="/blog/archives/"><i class="fa fa-list-ul"></i></a>
    <a href="https://github.com/braveMind" class="git" target="_blank"><i class="fa fa-github"></i></a>


    <a href="/blog/tags/think"><i class="fa fa-pencil-square-o"></i></a>
    <a href="/blog/2016/05/21/友情链接/"><i class="fa fa-link" aria-hidden="true"></i></a>

</div>
<div class="left_content">
    <section>
  
    <article id="post-maven插件编写" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/07/12/maven插件编写/">maven插件编写</a>
    </h1>
  

        <a href="/blog/2018/07/12/maven插件编写/" class="article-data-title">

  <time  datetime="2018-07-12T12:55:04.000Z" itemprop="datePublished">2018-07-12</time>
</a>

      </header>
    
   <!-- <div class="article-entry" itemprop="articleBody">
      
        <h2 id="创建maven项目"><a href="#创建maven项目" class="headerlink" title="创建maven项目"></a>创建maven项目</h2><p>1，创建一个maven 插件项目，执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DgroupId=com.jun.app -DartifactId=first-maven-plugin -DarchetypeGroupId=org.apache.maven.archetypes -DarchetypeArtifactId=maven-archetype-mojo</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>修改pom打包方式为  <packaging>maven-plugin</packaging></p>
</blockquote>
<h2 id="提前了解"><a href="#提前了解" class="headerlink" title="提前了解"></a>提前了解</h2><p>1，每个maven插件都必须包含一个或多个目标，maven称为Mojo(Maven old Object),编写插件必须继承AbstractMojo的类。</p>
<p>2，maven的大部分插件都是可以配置的，编写Mojo的时候需要提供配置参数。</p>
<p>3,maven运行出错时候，提供必须要的足够的日志。</p>
<h2 id="开始动手"><a href="#开始动手" class="headerlink" title="开始动手"></a>开始动手</h2><p>1，添加maven-plugin-api依赖。  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  			&lt;groupId&gt;org.apache.maven&lt;/groupId&gt;</span><br><span class="line">  			&lt;artifactId&gt;maven-plugin-api&lt;/artifactId&gt;</span><br><span class="line">  			&lt;version&gt;3.5.0&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2, 编写maven代码，核心步骤为  </p>
<ol>
<li>添加 <strong>@goal</strong>注解表示执行那个插件，插件入口的方法。</li>
<li>继承抽象方法 <strong>AbstractMojo</strong> 实现<strong>execute（）</strong> 方法</li>
<li>执行<strong>maven install</strong></li>
<li>执行插件 mvn groupId:artifactId:版本号：@goal标记的参数</li>
</ol>
<p>图示：<br><img src="http://7xstto.com1.z0.glb.clouddn.com/1.pic.jpg" alt="继承AbstractMojo"><br><img src="http://7xstto.com1.z0.glb.clouddn.com/4.pic_hd.jpg" alt=""></p>
<h2 id="添加参数"><a href="#添加参数" class="headerlink" title="添加参数"></a>添加参数</h2><p>maven从pom里面获取参数示例如下，更多复杂的数据可以参照官网。</p>
<p><a href="http://maven.apache.org/guides/mini/guide-configuring-plugins.html" target="_blank" rel="external">官网参数</a><br>代码参数<br><img src="http://7xstto.com1.z0.glb.clouddn.com/2.pic_hd.jpg" alt=""><br>截图示例：<br><img src="http://7xstto.com1.z0.glb.clouddn.com/3.pic.jpg" alt=""></p>
<h2 id="maven-命令简写"><a href="#maven-命令简写" class="headerlink" title="maven 命令简写"></a>maven 命令简写</h2><p>1.pom里面添加<goalprefix>first</goalprefix><br>2.settings.xml 里面添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;pluginGroups&gt;</span><br><span class="line">    &lt;pluginGroup&gt;org.sonatype.mavenbook.plugins&lt;/pluginGroup&gt;</span><br><span class="line">  &lt;/pluginGroups&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.sonatype.mavenbook.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;first-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">          &lt;outputDirectory&gt;Welcome&lt;/outputDirectory&gt;</span><br><span class="line">          &lt;timeout&gt;20&lt;/timeout&gt;</span><br><span class="line">          &lt;myFile&gt;c:\temp&lt;/myFile&gt;</span><br><span class="line">          &lt;reportPaths&gt;</span><br><span class="line">            &lt;reportPath&gt;/sd/test_report_1.xml&lt;/reportPath&gt;</span><br><span class="line">          &lt;/reportPaths&gt;</span><br><span class="line">          &lt;!--添加前缀 遵守maven &#123;prefix&#125;-maven-plugin命名规范 --&gt;</span><br><span class="line">          &lt;goalPrefix&gt;first&lt;/goalPrefix&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br></pre></td></tr></table></figure>
<h2 id="绑定插件生命周期"><a href="#绑定插件生命周期" class="headerlink" title="绑定插件生命周期"></a>绑定插件生命周期</h2><p>指定插件在maven运行的那个周期中运行例如</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">   &lt;plugins&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;plugin&gt;</span><br><span class="line">       &lt;groupId&gt;org.sonatype.mavenbook.plugins&lt;/groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;first-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">       &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">       &lt;configuration&gt;</span><br><span class="line">         &lt;outputDirectory&gt;Welcome&lt;/outputDirectory&gt;</span><br><span class="line">         &lt;timeout&gt;20&lt;/timeout&gt;</span><br><span class="line">         &lt;myFile&gt;c:\temp&lt;/myFile&gt;</span><br><span class="line">         &lt;reportPaths&gt;</span><br><span class="line">           &lt;reportPath&gt;/sd/test_report_1.xml&lt;/reportPath&gt;</span><br><span class="line">         &lt;/reportPaths&gt;</span><br><span class="line">         &lt;!--添加前缀 遵守maven &#123;prefix&#125;-maven-plugin命名规范 --&gt;</span><br><span class="line">         &lt;goalPrefix&gt;first&lt;/goalPrefix&gt;</span><br><span class="line">       &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!--绑定maven运行周期 在 maven 编译的时候运行插件--&gt;</span><br><span class="line">       &lt;executions&gt;</span><br><span class="line">         &lt;execution&gt;</span><br><span class="line">           &lt;id&gt;buildinfo&lt;/id&gt;</span><br><span class="line">           &lt;phase&gt;process-sources&lt;/phase&gt;</span><br><span class="line">           &lt;goals&gt;</span><br><span class="line">             &lt;goal&gt;hello&lt;/goal&gt;</span><br><span class="line">           &lt;/goals&gt;</span><br><span class="line">         &lt;/execution&gt;</span><br><span class="line">       &lt;/executions&gt;</span><br><span class="line">     &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">   &lt;/plugins&gt;</span><br><span class="line"> &lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>此时运行 maven clean install 会自动运行插件</p>
<p><img src="http://7xstto.com1.z0.glb.clouddn.com/s.pic_hd.jpg" alt=""></p>

      


    </div>-->
    <div class="article-entry" itemprop="articleBody">
      
      
      <h2 id="创建maven项目"><a href="#创建maven项目" class="headerlink" title="创建maven项目"></a>创建maven项目</h2><p>1，创建一个maven 插件项目，执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DgroupId=com.jun.app -DartifactId=first-maven-plugin -DarchetypeGroupId=org.apache.maven.archetypes -DarchetypeArtifactId=maven-archetype-mojo</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>修改pom打包方式为  <packaging>maven-plugin</packaging></p>
</blockquote>
<h2 id="提前了解"><a href="#提前了解" class="headerlink" title="提前了解"></a>提前了解</h2><p>1，每个maven插件都必须包含一个或多个目标，maven称为Mojo(Maven old Object),编写插件必须继承AbstractMojo的类。</p>
<p>2，maven的大部分插件都是可以配置的，编写Mojo的时候需要提供配置参数。</p>
<p>3,maven运行出错时候，提供必须要的足够的日志。</p>
<h2 id="开始动手"><a href="#开始动手" class="headerlink" title="开始动手"></a>开始动手</h2><p>1，添加maven-plugin-api依赖。  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  			&lt;groupId&gt;org.apache.maven&lt;/groupId&gt;</span><br><span class="line">  			&lt;artifactId&gt;maven-plugin-api&lt;/artifactId&gt;</span><br><span class="line">  			&lt;version&gt;3.5.0&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2, 编写maven代码，核心步骤为  </p>
<ol>
<li>添加 <strong>@goal</strong>注解表示执行那个插件，插件入口的方法。</li>
<li>继承抽象方法 <strong>AbstractMojo</strong> 实现<strong>execute（）</strong> 方法</li>
<li>执行<strong>maven install</strong></li>
<li>执行插件 mvn groupId:artifactId:版本号：@goal标记的参数</li>
</ol>
<p>图示：<br><img src="http://7xstto.com1.z0.glb.clouddn.com/1.pic.jpg" alt="继承AbstractMojo"><br><img src="http://7xstto.com1.z0.glb.clouddn.com/4.pic_hd.jpg" alt=""></p>
<h2 id="添加参数"><a href="#添加参数" class="headerlink" title="添加参数"></a>添加参数</h2><p>maven从pom里面获取参数示例如下，更多复杂的数据可以参照官网。</p>
<p><a href="http://maven.apache.org/guides/mini/guide-configuring-plugins.html" target="_blank" rel="external">官网参数</a><br>代码参数<br><img src="http://7xstto.com1.z0.glb.clouddn.com/2.pic_hd.jpg" alt=""><br>截图示例：<br><img src="http://7xstto.com1.z0.glb.clouddn.com/3.pic.jpg" alt=""></p>
<h2 id="maven-命令简写"><a href="#maven-命令简写" class="headerlink" title="maven 命令简写"></a>maven 命令简写</h2><p>1.pom里面添加<goalprefix>first</goalprefix><br>2.settings.xml 里面添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;pluginGroups&gt;</span><br><span class="line">    &lt;pluginGroup&gt;org.sonatype.mavenbook.plugins&lt;/pluginGroup&gt;</span><br><span class="line">  &lt;/pluginGroups&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.sonatype.mavenbook.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;first-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">          &lt;outputDirectory&gt;Welcome&lt;/outputDirectory&gt;</span><br><span class="line">          &lt;timeout&gt;20&lt;/timeout&gt;</span><br><span class="line">          &lt;myFile&gt;c:\temp&lt;/myFile&gt;</span><br><span class="line">          &lt;reportPaths&gt;</span><br><span class="line">            &lt;reportPath&gt;/sd/test_report_1.xml&lt;/reportPath&gt;</span><br><span class="line">          &lt;/reportPaths&gt;</span><br><span class="line">          &lt;!--添加前缀 遵守maven &#123;prefix&#125;-maven-plugin命名规范 --&gt;</span><br><span class="line">          &lt;goalPrefix&gt;first&lt;/goalPrefix&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br></pre></td></tr></table></figure>
<h2 id="绑定插件生命周期"><a href="#绑定插件生命周期" class="headerlink" title="绑定插件生命周期"></a>绑定插件生命周期</h2><p>指定插件在maven运行的那个周期中运行例如</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">   &lt;plugins&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;plugin&gt;</span><br><span class="line">       &lt;groupId&gt;org.sonatype.mavenbook.plugins&lt;/groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;first-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">       &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">       &lt;configuration&gt;</span><br><span class="line">         &lt;outputDirectory&gt;Welcome&lt;/outputDirectory&gt;</span><br><span class="line">         &lt;timeout&gt;20&lt;/timeout&gt;</span><br><span class="line">         &lt;myFile&gt;c:\temp&lt;/myFile&gt;</span><br><span class="line">         &lt;reportPaths&gt;</span><br><span class="line">           &lt;reportPath&gt;/sd/test_report_1.xml&lt;/reportPath&gt;</span><br><span class="line">         &lt;/reportPaths&gt;</span><br><span class="line">         &lt;!--添加前缀 遵守maven &#123;prefix&#125;-maven-plugin命名规范 --&gt;</span><br><span class="line">         &lt;goalPrefix&gt;first&lt;/goalPrefix&gt;</span><br><span class="line">       &lt;/configuration&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!--绑定maven运行周期 在 maven 编译的时候运行插件--&gt;</span><br><span class="line">       &lt;executions&gt;</span><br><span class="line">         &lt;execution&gt;</span><br><span class="line">           &lt;id&gt;buildinfo&lt;/id&gt;</span><br><span class="line">           &lt;phase&gt;process-sources&lt;/phase&gt;</span><br><span class="line">           &lt;goals&gt;</span><br><span class="line">             &lt;goal&gt;hello&lt;/goal&gt;</span><br><span class="line">           &lt;/goals&gt;</span><br><span class="line">         &lt;/execution&gt;</span><br><span class="line">       &lt;/executions&gt;</span><br><span class="line">     &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">   &lt;/plugins&gt;</span><br><span class="line"> &lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>此时运行 maven clean install 会自动运行插件</p>
<p><img src="http://7xstto.com1.z0.glb.clouddn.com/s.pic_hd.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://bravemind.github.io/blog/2018/07/12/maven插件编写/" data-id="cjjksbcl6002wlroxkjdhyym9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/java基础/">java基础</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-mysql锁" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/05/28/mysql锁/">mysql insert Gap死锁</a>
    </h1>
  

        <a href="/blog/2018/05/28/mysql锁/" class="article-data-title">

  <time  datetime="2018-05-28T08:33:13.000Z" itemprop="datePublished">2018-05-28</time>
</a>

      </header>
    
   <!-- <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Gap 锁死锁问题</p>
</blockquote>
<p>线上时不时会报mysql-insert-deadlock,经排查发现是由于gap锁和Insert Intention锁多线程并发时互斥而造成的死锁。<br>原代码逻辑：<br>先删除（通过索引删除），再插入gap锁：</p>
<h2 id="例子分析"><a href="#例子分析" class="headerlink" title="例子分析"></a>例子分析</h2><p>执行 delete from <code>order</code> where customer_id = 3。这里在order表里面没有customer_id=3 的记录。但是又由于customer_id存在一个索引，mysql根据索引进行搜索，索引的key是(1,2,6)，3不在这些key里面而是位于(2,6)之间的gap（间隙）中。Mysql对于(2,6)这个间隙加的锁就叫做Gap锁。</p>
<h2 id="场景举例"><a href="#场景举例" class="headerlink" title="场景举例"></a>场景举例</h2><p>原有逻辑分析(举例)：</p>
<p>A   ：T1  stagedPoiRoomBedInfoDAO.deleteByRoomId(3);</p>
<p>B   ：T2  stagedPoiRoomBedInfoDAO.deleteByRoomId(4);</p>
<p>C   ：T1  stagedPoiRoomBedInfoDAO.insert(stagedPoiRoomBedInfoDO1);</p>
<p>D   ：T2  stagedPoiRoomBedInfoDAO.insert(stagedPoiRoomBedInfoDO2);</p>
<p> 执行A语句完毕，T1持有了Gap(2,6)的X锁；（假设3，4在索引段2，6之间）</p>
<p> 执行B语句，T2 申请Gap(2,6)的X锁，该申请被授权，所以T2 持有了Gap(2,6)的X锁。</p>
<p> 执行C语句，T1 申请Insert Intention (2,6)的X锁，根据之前讲的互斥关系，由于T2持有Gap(2,6)的X锁，该申请被block。</p>
<p> 执行D语句，T2 申请 Insert Intention(2,6)的X锁，根据之前讲的互斥关系，由于T1持有Gap(2,6)的X锁，该申请被block。</p>
<p> 这里一个死锁很明显的出现，T1与T2都持有一个锁，同时都在等对方释放一个锁。到这里，整个死锁的原因分析清楚了。  </p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>只要消除了Gap锁，这个死锁就解决了。</p>
<p>在delete的时候，不让事务获取到Gap锁。比如，在执行delete from   <code>order</code>  where customer_id = 3 ;之前， 我们可以先用主键查询看数据是否存在，存在再用主键删除，即可解决上述的死锁问题。</p>
<p><strong>ps：两个锁的互斥关系如下</strong><br>存在Insert Intention 锁时，申请Gap锁是允许的；但是存在Gap锁时，申请Insert Intention锁时是被阻止的。<strong>Gap锁是共享锁。</strong></p>
<h2 id="什么时候会取得-gap-lock-或nextKey锁"><a href="#什么时候会取得-gap-lock-或nextKey锁" class="headerlink" title="什么时候会取得 gap lock 或nextKey锁"></a>什么时候会取得 gap lock 或nextKey锁</h2><p>这和隔离级别有关,只在REPEATABLE READ或以上的隔离级别下的特定操作才会取得gap lock或nextkey lock。</p>
<p>For locking reads (<strong>SELECT with FOR UPDATE or LOCK IN SHARE MODE</strong>), <strong>UPDATE statements, and DELETE statements</strong>, InnoDB locks only index records, not the gaps before them, and thus permits the free insertion of new records next to locked records. Gap locking is only used for foreign-key constraint checking and duplicate-key checking.</p>
<p>Because gap locking is disabled, phantom problems may occur, as other sessions can insert new rows into the gaps. For information about phantoms, see Section 14.5.4, “Phantom Rows”.</p>
<p>Only row-based binary logging is supported with the READ COMMITTED isolation level. If you use READ COMMITTED with binlog_format=MIXED, the server automatically uses row-based logging.</p>
<p>Using READ COMMITTED has additional effects:</p>
<p>For UPDATE or DELETE statements, InnoDB holds locks only for rows that it updates or deletes. Record locks for nonmatching rows are released after MySQL has evaluated the WHERE condition. This greatly reduces the probability of deadlocks, but they can still happen.</p>
<p>For UPDATE statements, if a row is already locked, InnoDB performs a “semi-consistent” read, returning the latest committed version to MySQL so that MySQL can determine whether the row matches the WHERE condition of the UPDATE. If the row matches (must be updated), MySQL reads the row again and this time InnoDB either locks it or waits for a lock on it.</p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html" target="_blank" rel="external">参考</a></p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>GAP锁，锁的是区间，并不是最末端的几行，最大的记录到 +∞区间都被锁了，这个区间内的所有插入都会失败</p>
<p>举个例子，表中最大id是10，错误id是10000，这样锁住的范围是10 ~ 正无穷大。这样插入大于10的id都会锁等待。</p>

      


    </div>-->
    <div class="article-entry" itemprop="articleBody">
      
      
      <blockquote>
<p>Gap 锁死锁问题</p>
</blockquote>
<p>线上时不时会报mysql-insert-deadlock,经排查发现是由于gap锁和Insert Intention锁多线程并发时互斥而造成的死锁。<br>原代码逻辑：<br>先删除（通过索引删除），再插入gap锁：</p>
<h2 id="例子分析"><a href="#例子分析" class="headerlink" title="例子分析"></a>例子分析</h2><p>执行 delete from <code>order</code> where customer_id = 3。这里在order表里面没有customer_id=3 的记录。但是又由于customer_id存在一个索引，mysql根据索引进行搜索，索引的key是(1,2,6)，3不在这些key里面而是位于(2,6)之间的gap（间隙）中。Mysql对于(2,6)这个间隙加的锁就叫做Gap锁。</p>
<h2 id="场景举例"><a href="#场景举例" class="headerlink" title="场景举例"></a>场景举例</h2><p>原有逻辑分析(举例)：</p>
<p>A   ：T1  stagedPoiRoomBedInfoDAO.deleteByRoomId(3);</p>
<p>B   ：T2  stagedPoiRoomBedInfoDAO.deleteByRoomId(4);</p>
<p>C   ：T1  stagedPoiRoomBedInfoDAO.insert(stagedPoiRoomBedInfoDO1);</p>
<p>D   ：T2  stagedPoiRoomBedInfoDAO.insert(stagedPoiRoomBedInfoDO2);</p>
<p> 执行A语句完毕，T1持有了Gap(2,6)的X锁；（假设3，4在索引段2，6之间）</p>
<p> 执行B语句，T2 申请Gap(2,6)的X锁，该申请被授权，所以T2 持有了Gap(2,6)的X锁。</p>
<p> 执行C语句，T1 申请Insert Intention (2,6)的X锁，根据之前讲的互斥关系，由于T2持有Gap(2,6)的X锁，该申请被block。</p>
<p> 执行D语句，T2 申请 Insert Intention(2,6)的X锁，根据之前讲的互斥关系，由于T1持有Gap(2,6)的X锁，该申请被block。</p>
<p> 这里一个死锁很明显的出现，T1与T2都持有一个锁，同时都在等对方释放一个锁。到这里，整个死锁的原因分析清楚了。  </p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>只要消除了Gap锁，这个死锁就解决了。</p>
<p>在delete的时候，不让事务获取到Gap锁。比如，在执行delete from   <code>order</code>  where customer_id = 3 ;之前， 我们可以先用主键查询看数据是否存在，存在再用主键删除，即可解决上述的死锁问题。</p>
<p><strong>ps：两个锁的互斥关系如下</strong><br>存在Insert Intention 锁时，申请Gap锁是允许的；但是存在Gap锁时，申请Insert Intention锁时是被阻止的。<strong>Gap锁是共享锁。</strong></p>
<h2 id="什么时候会取得-gap-lock-或nextKey锁"><a href="#什么时候会取得-gap-lock-或nextKey锁" class="headerlink" title="什么时候会取得 gap lock 或nextKey锁"></a>什么时候会取得 gap lock 或nextKey锁</h2><p>这和隔离级别有关,只在REPEATABLE READ或以上的隔离级别下的特定操作才会取得gap lock或nextkey lock。</p>
<p>For locking reads (<strong>SELECT with FOR UPDATE or LOCK IN SHARE MODE</strong>), <strong>UPDATE statements, and DELETE statements</strong>, InnoDB locks only index records, not the gaps before them, and thus permits the free insertion of new records next to locked records. Gap locking is only used for foreign-key constraint checking and duplicate-key checking.</p>
<p>Because gap locking is disabled, phantom problems may occur, as other sessions can insert new rows into the gaps. For information about phantoms, see Section 14.5.4, “Phantom Rows”.</p>
<p>Only row-based binary logging is supported with the READ COMMITTED isolation level. If you use READ COMMITTED with binlog_format=MIXED, the server automatically uses row-based logging.</p>
<p>Using READ COMMITTED has additional effects:</p>
<p>For UPDATE or DELETE statements, InnoDB holds locks only for rows that it updates or deletes. Record locks for nonmatching rows are released after MySQL has evaluated the WHERE condition. This greatly reduces the probability of deadlocks, but they can still happen.</p>
<p>For UPDATE statements, if a row is already locked, InnoDB performs a “semi-consistent” read, returning the latest committed version to MySQL so that MySQL can determine whether the row matches the WHERE condition of the UPDATE. If the row matches (must be updated), MySQL reads the row again and this time InnoDB either locks it or waits for a lock on it.</p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html" target="_blank" rel="external">参考</a></p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>GAP锁，锁的是区间，并不是最末端的几行，最大的记录到 +∞区间都被锁了，这个区间内的所有插入都会失败</p>
<p>举个例子，表中最大id是10，错误id是10000，这样锁住的范围是10 ~ 正无穷大。这样插入大于10的id都会锁等待。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://bravemind.github.io/blog/2018/05/28/mysql锁/" data-id="cjjksbcld0034lroxjl6qx5zt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Mysql/">Mysql</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-反射调用被Spring代理的类" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/05/反射调用被Spring代理的类/">反射调用被Spring代理的类</a>
    </h1>
  

        <a href="/blog/2017/12/05/反射调用被Spring代理的类/" class="article-data-title">

  <time  datetime="2017-12-05T10:10:47.000Z" itemprop="datePublished">2017-12-05</time>
</a>

      </header>
    
   <!-- <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>正常：项目中有自定义注解，该注解修饰在方法上，正常情况下当Spring启动的时候会扫描该注解，扫描到该注解，在对该方法进行放射调用。</p>
<p>异常：在使用该注解的同时使用SpringAop，例如添加@Transation等，此时代理类 <strong>方法</strong> 里面是不会有该注解的，此时就会报错。</p>
<p>解决方法：获取代理类的原始方法类型，再通过method.invoke(代理bean,参数类型)进行调用。</p>
</blockquote>
<p>思维误区：没有意识到生成的代理类，通过方法名字，和参数类型，也可以进行代理方法调用。</p>
<p>调用方法例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (AopUtils.isAopProxy(jobCallBack)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">				</span><br><span class="line">                    Object jobTarget = AopTargetUtils.getTarget(jobCallBack);</span><br><span class="line">                    Method[] methods = jobTarget.getClass().getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                        Clock clock = method.getAnnotation(Clock.class);</span><br><span class="line">                        <span class="keyword">if</span> (clock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!StringUtils.isEmpty(clock.name())) &#123;</span><br><span class="line"></span><br><span class="line">                                methodMap.put(clock.name(), method);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                                methodMap.put(method.getName(), method);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">            ....</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (m != <span class="keyword">null</span> &amp;&amp; m.getParameterTypes().length == <span class="number">1</span>) &#123;</span><br><span class="line">                		<span class="comment">//jobCallBack代理类，m为被代理的原始方法！</span></span><br><span class="line">                    m.invoke(jobCallBack, (String) jobParams.getParams());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    m.invoke(jobCallBack);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                    log.info(<span class="string">"business ok"</span>);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>反思：不要想当然。。。。巩固基础，也不要把简单问题复杂化。</p>
</blockquote>

      


    </div>-->
    <div class="article-entry" itemprop="articleBody">
      
      
      <blockquote>
<p>正常：项目中有自定义注解，该注解修饰在方法上，正常情况下当Spring启动的时候会扫描该注解，扫描到该注解，在对该方法进行放射调用。</p>
<p>异常：在使用该注解的同时使用SpringAop，例如添加@Transation等，此时代理类 <strong>方法</strong> 里面是不会有该注解的，此时就会报错。</p>
<p>解决方法：获取代理类的原始方法类型，再通过method.invoke(代理bean,参数类型)进行调用。</p>
</blockquote>
<p>思维误区：没有意识到生成的代理类，通过方法名字，和参数类型，也可以进行代理方法调用。</p>
<p>调用方法例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (AopUtils.isAopProxy(jobCallBack)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">				</span><br><span class="line">                    Object jobTarget = AopTargetUtils.getTarget(jobCallBack);</span><br><span class="line">                    Method[] methods = jobTarget.getClass().getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                        Clock clock = method.getAnnotation(Clock.class);</span><br><span class="line">                        <span class="keyword">if</span> (clock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!StringUtils.isEmpty(clock.name())) &#123;</span><br><span class="line"></span><br><span class="line">                                methodMap.put(clock.name(), method);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                                methodMap.put(method.getName(), method);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">            ....</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (m != <span class="keyword">null</span> &amp;&amp; m.getParameterTypes().length == <span class="number">1</span>) &#123;</span><br><span class="line">                		<span class="comment">//jobCallBack代理类，m为被代理的原始方法！</span></span><br><span class="line">                    m.invoke(jobCallBack, (String) jobParams.getParams());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    m.invoke(jobCallBack);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                    log.info(<span class="string">"business ok"</span>);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>反思：不要想当然。。。。巩固基础，也不要把简单问题复杂化。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://bravemind.github.io/blog/2017/12/05/反射调用被Spring代理的类/" data-id="cjjksbclt003tlrox28ewrxy3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/java基础/">java基础</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-jprofile" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/21/jprofile/">jprofile</a>
    </h1>
  

        <a href="/blog/2017/11/21/jprofile/" class="article-data-title">

  <time  datetime="2017-11-21T07:27:58.000Z" itemprop="datePublished">2017-11-21</time>
</a>

      </header>
    
   <!-- <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>服务器端jvm工具安装</p>
</blockquote>
<p>1，wget <a href="https://download-keycdn.ej-technologies.com/jprofiler/jprofiler_linux_9_2_1.sh" target="_blank" rel="external">https://download-keycdn.ej-technologies.com/jprofiler/jprofiler_linux_9_2_1.sh</a></p>
<p>2，sh jprofiler_linux_9_2_1.sh</p>
<p>3, /opt/jprofiler9/bin</p>
<p>4, sudo -u nobody sh jpenable</p>
<blockquote>
<p>注意服务器版本和客户端版本必须一致！</p>
</blockquote>

      


    </div>-->
    <div class="article-entry" itemprop="articleBody">
      
      
      <blockquote>
<p>服务器端jvm工具安装</p>
</blockquote>
<p>1，wget <a href="https://download-keycdn.ej-technologies.com/jprofiler/jprofiler_linux_9_2_1.sh" target="_blank" rel="external">https://download-keycdn.ej-technologies.com/jprofiler/jprofiler_linux_9_2_1.sh</a></p>
<p>2，sh jprofiler_linux_9_2_1.sh</p>
<p>3, /opt/jprofiler9/bin</p>
<p>4, sudo -u nobody sh jpenable</p>
<blockquote>
<p>注意服务器版本和客户端版本必须一致！</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://bravemind.github.io/blog/2017/11/21/jprofile/" data-id="cjjksbckv002ilrox4zzhutu3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-jafka-broker分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/08/jafka-broker分析/">jafka broker分析</a>
    </h1>
  

        <a href="/blog/2017/11/08/jafka-broker分析/" class="article-data-title">

  <time  datetime="2017-11-08T09:37:13.000Z" itemprop="datePublished">2017-11-08</time>
</a>

      </header>
    
   <!-- <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>broker在消息系统中就是负责消息处理的一台物理机器。一个broker包含：id,creatorId,host,port。</p>
</blockquote>
<p>Partion是broker的集合，客户端选择发送消息的时候通过配置文件，把消息发送到对应的broker上。</p>

      


    </div>-->
    <div class="article-entry" itemprop="articleBody">
      
      
      <blockquote>
<p>broker在消息系统中就是负责消息处理的一台物理机器。一个broker包含：id,creatorId,host,port。</p>
</blockquote>
<p>Partion是broker的集合，客户端选择发送消息的时候通过配置文件，把消息发送到对应的broker上。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://bravemind.github.io/blog/2017/11/08/jafka-broker分析/" data-id="cjjksbckf001wlroxbruo6532" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/java基础/">java基础</a></li></ul>

    </footer>
  </div>
  
</article>




  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="page-number" href="/blog/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/21/">21</a><a class="extend next" rel="next" href="/blog/page/2/">Next &raquo;</a>
    </nav>
  
</section>
</div>


   

   <script src="/blog/js/jQuery.js"></script>
   <script src="/blog/js/script.js"></script>



